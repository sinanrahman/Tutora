<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>View Invoices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="/css/admin/viewstudents.css">
</head>

<body class="bg-light">

  <!-- Mobile Topbar -->
  <div class="d-md-none mobile-topbar fixed-top bg-light shadow-sm">
    <div class="d-flex align-items-center justify-content-between px-3" style="height:60px;">
      <img src="/image/logo.png" class="mobile-logo-img">
      <button class="btn btn-light" onclick="toggleSidebar()">
        <i class="bi bi-list fs-4"></i>
      </button>
    </div>
  </div>

  <%- include('partials/navbar') %>
  <%- include('../partials/sidebar') %>

  <div class="main-content p-5">

    <div class="card shadow-sm border-0">
      <!-- Breadcrumb -->
      <nav style="--bs-breadcrumb-divider:'>';">
        <ol class="breadcrumb p-3">
          <li class="breadcrumb-item"><a href="/admin/Dashboard">Home</a></li>
          <li class="breadcrumb-item"><a href="/admin/addinvoice">Invoices</a></li>
         <li class="breadcrumb-item active">View Invoices</li>
        </ol>
      </nav>

      <div class="card-body">

        <div class="text-center mb-4">
          <h3 class="fw-bold fs-2" style="color:#870216;">INVOICES</h3>
         
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle" id="invoiceTable">
            <thead class="table-light">
              <tr>
                <th>Sl No</th>
                <th>Invoice ID</th>
                <th>Student ID</th>
                <th>Date</th>
                <th>Status</th>
                <th>Total (₹)</th>
    
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <% if (invoices.length === 0) { %>
                <tr>
                  <td colspan="8" class="text-center text-muted">No invoices found</td>
                </tr>
              <% } else { %>

                <% invoices.forEach((inv, i) => { %>
                  <tr>
                    <td><%= i + 1 %></td>

                    <td class="fw-semibold"><%= inv.id %></td>

                    <td><%= inv.studentId || '—' %></td>

                    <td>
                      <%= inv.date ? new Date(inv.date).toLocaleDateString('en-IN') : '—' %>
                    </td>

                    <td>
                      <span class="badge <%= inv.paid ? 'bg-success' : 'bg-warning text-dark' %>">
                        <%= inv.paid ? 'Paid' : 'Unpaid' %>
                      </span>
                    </td>
                    <td class="fw-bold">₹ <%= inv.amount %></td>
                
                 <td class="action-group text-center"> 
                    <a href="/admin/viewinvoice/<%= inv.id %>" class="btn btn-outline-danger btn-sm" title="View Invoice"> 
                        <i class="bi bi-file-earmark-pdf-fill"></i> </a>

                    <button
                        class="btn btn-outline-primary btn-sm ms-1"
                        title="Edit Payment Status"
                        data-bs-toggle="modal"
                        data-bs-target="#editStatusModal"
                        onclick="openEditModal('<%= inv._id %>',<%= inv.paid %>)">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                    </td>
                  </tr>
                <% }) %>

              <% } %>
            </tbody>
          </table>
          <a href="/admin/addinvoice"><button class="btn btn-secondary">Back</button></a>
        </div>

      </div>
    </div>
  </div>

  <!-- Edit Payment Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" id="editStatusForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Payment Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Payment Status</label>
            <select class="form-select" name="paid" id="paidSelect" required>
              <option value="true">Paid</option>
              <option value="false">Unpaid</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Update Status
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

  <!-- Scripts -->
  <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.js"></script>

  <script>
    new DataTable('#invoiceTable', {
      responsive: true,
      pageLength: 10
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    document.addEventListener('click', function (e) {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.querySelector('.bi-list')?.parentElement;

      if (
        window.innerWidth < 768 &&
        sidebar.classList.contains('active') &&
        !sidebar.contains(e.target) &&
        !toggleBtn?.contains(e.target)
      ) {
        sidebar.classList.remove('active');
      }
    });


     function openEditModal(invoiceId, isPaid) {
    const form = document.getElementById('editStatusForm');
    const paidSelect = document.getElementById('paidSelect');

    // Set form action dynamically
    form.action = `/admin/invoice/updatestatus/${invoiceId}`;

    // Set current status
    paidSelect.value = isPaid ? 'true' : 'false';
  }
  </script>
</body>
</html>
