<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Progress Report â€“ <%= student.fullName %></title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    /* ===== YOUR ORIGINAL THEME (UNCHANGED) ===== */
    body { background-color: #f2f2f2; }

    .heading { color: #870216; }

    .card {
      background-color: #ffffff;
      border: 1px solid #e1e1e1;
    }

    .breadcrumb a { color: #870216; }

    .chart-card canvas {
      height: 360px !important;
      width: 100% !important;
    }

    .controls-inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .year-select { min-width: 120px; }

    /* ===== MOBILE ONLY (NO DESIGN CHANGE) ===== */
    @media (max-width: 576px) {
      .chart-card canvas {
        height: 260px !important;
      }

      .controls-inline {
        gap: 0.4rem;
      }

      h3.heading {
        font-size: 1.25rem;
      }
    }

    /* ===== MOBILE RESPONSIVE FIX (NEW) ===== */
    @media (max-width: 576px) {

      /* Prevent horizontal scroll */
      body,
      .main-content {
        overflow-x: hidden;
      }

      /* Main container padding fix */
      .container {
        padding-left: 12px !important;
        padding-right: 12px !important;
      }

      /* Card should not overflow screen */
      .card {
        width: 100%;
      }

      /* Summary cards spacing */
      .row > [class*="col-"] {
        margin-bottom: 0.75rem;
      }

      /* Controls: stack dropdowns neatly */
      .controls-inline {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }

      .controls-inline .form-select {
        width: 100%;
      }

      /* Chart container fix */
      .chart-card {
        padding: 1rem !important;
      }

      .chart-card canvas {
        max-width: 100% !important;
      }

      /* Breadcrumb spacing */
      .breadcrumb {
        padding: 0.75rem !important;
      }

      /* Button full-width only on mobile */
      .text-end .btn {
        width: 100%;
        margin-top: 0.5rem; /* Gap between button and chartHint */
      }
    }

    /* ===== CHART LABELS FIX ===== */
    /* decrease x-axis label font size for all screens */
    canvas#reportChart {
      /* Chart.js controls labels via options, but we can scale globally via CSS fallback */
      max-width: 100%;
    }
  </style>
</head>

<body class="bg-light">

<%- include('../partials/parentNavbar') %>
<%- include('../partials/sidebar') %>

<div class="main-content">
  <div class="container py-4">
    <div class="card rounded-4 shadow-sm p-4">

      <!-- Breadcrumb -->
      <nav style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
        <ol class="breadcrumb p-3 mb-0">
          <li class="breadcrumb-item">
            <a href="/parent/dashboard">Home</a>
          </li>
          <li class="breadcrumb-item active">Progress Report</li>
        </ol>
      </nav>

      <h3 class="fw-bold heading text-center mb-4">
        Progress Report
      </h3>

      <!-- SUMMARY -->
      <div class="row mb-4 justify-content-center">
        <div class="col-md-4">
          <div class="card p-3 text-center bg-light">
            <h4 class="text-danger">
              <%= reports.length ? reports[reports.length - 1].score : 0 %>%
            </h4>
            <small>Latest Score</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 text-center bg-light">
            <h4 class="text-danger"><%= reports.length %></h4>
            <small>Total Reports</small>
          </div>
        </div>
      </div>

      <!-- CHART (DESIGN UNCHANGED) -->
      <div class="card rounded-4 shadow-sm p-4 mb-4 chart-card">
        <div class="d-flex justify-content-between mb-2">
          <div class="controls-inline">
            <select id="yearSelect" class="form-select year-select"></select>
            <select id="typeSelect" class="form-select year-select">
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <small id="chartHint" class="text-muted" style="margin-left:1rem;">Weekly performance (all weeks)</small>
        </div>

        <canvas id="reportChart"></canvas>
      </div>

      <!-- VIEW TABLE BUTTON -->
      <div class="text-end mb-3">
        <a href="/parent/report/table?studentId=<%= student._id %>"
           class="btn btn-outline-danger btn-sm">
          View Detailed Table
        </a>
      </div>

    </div>
  </div>
</div>

<!-- ================= CHART SCRIPT (LOGIC UNCHANGED) ================= -->
<script>
const rawReports = <%- JSON.stringify(reports) %>;
const CURRENT_YEAR = new Date().getFullYear();

const yearSelect = document.getElementById('yearSelect');
const typeSelect = document.getElementById('typeSelect');
const chartHint = document.getElementById('chartHint');
const ctx = document.getElementById('reportChart').getContext('2d');

let chart;

/* YEAR OPTIONS */
for (let y = CURRENT_YEAR - 4; y <= CURRENT_YEAR; y++) {
  yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
}
yearSelect.value = CURRENT_YEAR;

/* WEEKLY DATA */
function weeklyData(year) {
  const labels = [];
  const data = [];

  for (let m = 1; m <= 12; m++) {
    const daysInMonth = new Date(year, m, 0).getDate();
    const weeks = Math.ceil(daysInMonth / 7);
    const safeWeeks = Math.max(weeks, 5);

    const mName = new Date(year, m - 1, 1).toLocaleString('default', { month: 'short' });

    const monthlyReport = rawReports.find(r =>
      r.year === year && r.type === 'monthly' && r.month === m
    );

    for (let w = 1; w <= safeWeeks; w++) {
      labels.push(`${mName} W${w}`);

      const weeklyReport = rawReports.find(r =>
        r.year === year && r.type === 'weekly' && r.month === m && r.week === w
      );

      if (weeklyReport) data.push(weeklyReport.score);
      else if (monthlyReport) data.push(monthlyReport.score);
      else data.push(null);
    }
  }
  return { labels, data };
}

/* MONTHLY DATA */
function monthlyData(year) {
  const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const data = new Array(12).fill(null);

  for (let m = 1; m <= 12; m++) {
    const r = rawReports.find(r =>
      r.year === year && r.type === 'monthly' && r.month === m
    );
    if (r) data[m - 1] = r.score;
  }
  return { labels, data };
}

/* RENDER CHART */
function renderChart() {
  const year = +yearSelect.value;
  const type = typeSelect.value;
  const payload = type === 'monthly' ? monthlyData(year) : weeklyData(year);

  chartHint.textContent =
    type === 'monthly'
      ? 'Monthly performance overview'
      : 'Weekly performance (all weeks)';

  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: payload.labels,
        datasets: [{
          data: payload.data,
          spanGaps: true,
          tension: 0.35,
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 10,
          borderColor: '#870216',
          borderWidth: 1.5,
          backgroundColor: (() => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 360);
            gradient.addColorStop(0, 'rgba(135,2,22,0.35)');
            gradient.addColorStop(1, 'rgba(135,2,22,0.05)');
            return gradient;
          })(),
          pointBackgroundColor: '#870216',
          fill: true
        }]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { min: 0, max: 100 },
          x: {
            ticks: {
              autoSkip: true,
              maxTicksLimit: 12,
              font: { size: 10 }, // <-- DECREASED LABEL FONT SIZE
              callback: (val, index) =>
                type === 'monthly'
                  ? payload.labels[index]
                  : payload.labels[index].split(' ')[0]
            }
          }
        }
      }
    });
  } else {
    chart.data.labels = payload.labels;
    chart.data.datasets[0].data = payload.data;
    chart.update();
  }
}

yearSelect.onchange = renderChart;
typeSelect.onchange = renderChart;
renderChart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
