<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Progress Report – <%= student.fullName %></title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .heading { color: #870216; }

    .chart-card { padding: 1rem; }
    .chart-card .chart-canvas {
      height: 360px;
      max-height: 480px;
      width: 100%;
      display: block;
    }

    .controls-inline { display:flex; gap:0.5rem; align-items:center; }
    .year-select { min-width:110px; }
  </style>
</head>
<body class="bg-light">

  <%- include('../partials/parentNavbar') %>
  <%- include('../partials/sidebar') %>

  <div class="main-content">
    <div class="container py-4">

      <div class="card rounded-4 shadow-sm p-4">

        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a href="/parent/dashboard" class="text-decoration-none">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Progress Report</li>
          </ol>
        </nav>

        <!-- Heading & Controls -->
        <div class="d-flex align-items-center justify-content-center mb-4 gap-3">
          <div>
            <h4 class="fw-bold heading mb-1 fs-2">Student Progress Report</h4>
          </div>
        </div>

        <!-- Summary Boxes -->
        <div class="row g-3 mb-4 justify-content-center">
          <div class="col-md-4 col-sm-6">
            <div class="card rounded-4 shadow-sm p-4 text-center h-100 bg-success-subtle">
              <h5 class="fw-bold text-primary mb-1">
                <%= reports && reports.length ? reports[reports.length - 1].score : 0 %>%
              </h5>
              <small class="text-muted">Latest Score</small>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="card rounded-4 shadow-sm p-4 text-center h-100 bg-danger-subtle">
              <h5 class="fw-bold text-success mb-1">
                <%= reports ? reports.length : 0 %>
              </h5>
              <small class="text-muted">Total Reports</small>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="card rounded-4 shadow-sm p-4 mb-4 chart-card">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="controls-inline">
            <label class="me-2 text-muted" for="yearSelect">Year</label>
            <select id="yearSelect" class="form-select year-select" aria-label="Select year"></select>
          </div>
            <div class="text-muted small">Weekly progress shown inside monthly groups. Hover datapoints for details.</div>
          </div>
          <canvas id="reportChart" class="chart-canvas" aria-label="Student progress chart"></canvas>
          <div class="mt-2">
            <small class="text-muted">Tip: For the current year, only data up to the current week is shown by default.</small>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-pills mb-3 justify-content-center">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#weekly" type="button">Weekly</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#monthly" type="button">Monthly</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#yearly" type="button">Yearly</button></li>
        </ul>

        <div class="tab-content">

          <!-- WEEKLY -->
          <div class="tab-pane fade show active" id="weekly">
            <div class="card rounded-4 shadow-sm p-4">
              <table class="table table-bordered text-center align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Week</th><th>Score</th><th>Remarks</th></tr>
                </thead>
                <tbody>
                  <% (reports || []).forEach(r => { if(r.type==='weekly'){ %>
                    <tr>
                      <td><%= r.viewDate %></td>
                      <td><%= r.score %>%</td>
                      <td><%= r.remarks || '—' %></td>
                    </tr>
                  <% }}); %>
                  <% if (!reports || !reports.some(r=>r.type==='weekly')) { %>
                    <tr><td colspan="3" class="text-muted">No weekly data</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- MONTHLY -->
          <div class="tab-pane fade" id="monthly">
            <div class="card rounded-4 shadow-sm p-4">
              <table class="table table-bordered text-center align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Month</th><th>Score</th><th>Remarks</th></tr>
                </thead>
                <tbody>
                  <% (reports || []).forEach(r => { if(r.type==='monthly'){ %>
                    <tr>
                      <td><%= r.viewDate %></td>
                      <td><%= r.score %>%</td>
                      <td><%= r.remarks || '—' %></td>
                    </tr>
                  <% }}); %>
                  <% if (!reports || !reports.some(r=>r.type==='monthly')) { %>
                    <tr><td colspan="3" class="text-muted">No monthly data</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- YEARLY -->
          <div class="tab-pane fade" id="yearly">
            <div class="card rounded-4 shadow-sm p-4">
              <table class="table table-bordered text-center align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Year</th><th>Score</th><th>Remarks</th></tr>
                </thead>
                <tbody>
                  <% (reports || []).forEach(r => { %>
                    <tr>
                      <td><%= r.year %></td>
                      <td><%= r.score %>%</td>
                      <td><%= r.remarks || '—' %></td>
                    </tr>
                  <% }); %>
                  <% if (!reports || !reports.length) { %>
                    <tr><td colspan="3" class="text-muted">No yearly data</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <div class="mt-4">
          <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
            <i class="bi bi-arrow-left"></i> Back
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Chart Script -->
  <script>
    const rawReports = <%- JSON.stringify(reports || []) %>;
    const CURRENT_YEAR = new Date().getFullYear();

    function buildYearStructure(year) {
      const labels = [], months = [];
      for (let m=0;m<12;m++){
        const dim = new Date(year,m+1,0).getDate();
        const weeks = Math.ceil(dim/7);
        const startIndex = labels.length;
        const name = new Date(year,m,1).toLocaleString(undefined,{month:'short'});
        for (let w=1; w<=weeks; w++) labels.push(`${name} W${w}`);
        months.push({name,startIndex,endIndex:labels.length-1,weeks});
      }
      return {labels,months,totalWeeks:labels.length};
    }

    // Robust mapping: use the yearStruct.months to map month/week -> index
    function mapReportsToYear(year, yearStruct){
      const arr = new Array(yearStruct.totalWeeks).fill(null);
      const monthWeekToIndex = {};

      yearStruct.months.forEach((m, monthIdx) => {
        const monthNumber = monthIdx + 1;
        for (let w = 1; w <= m.weeks; w++) {
          const idx = m.startIndex + (w - 1);
          monthWeekToIndex[`${monthNumber}-${w}`] = idx;
        }
      });

      rawReports.forEach(r=>{
        if (Number(r.year) !== Number(year)) return;
        const month = Number(r.month);
        const week = Number(r.week);
        if (!month || !week) return;
        const key = `${month}-${week}`;
        const idx = monthWeekToIndex[key];
        if (typeof idx === 'number') {
          const scoreVal = r.score == null ? null : Number(r.score);
          if (!isNaN(scoreVal)) arr[idx] = scoreVal;
        }
      });

      return arr;
    }

    function weeksElapsedThisYear(year){
      const now=new Date();
      if(Number(year)!==now.getFullYear()) return null;
      let total=0;
      for(let m=0;m<now.getMonth();m++) total+=Math.ceil(new Date(year,m+1,0).getDate()/7);
      total += Math.ceil(now.getDate()/7);
      return total;
    }

    const yearSelect=document.getElementById('yearSelect');

    function populateYearSelect(){
      const years=[];
      for(let y=CURRENT_YEAR-4;y<=CURRENT_YEAR;y++) years.push(y);
      yearSelect.innerHTML='';
      years.reverse().forEach(y=>{
        const opt=document.createElement('option');
        opt.value=y; opt.textContent=y;
        yearSelect.appendChild(opt);
      });
      yearSelect.value=CURRENT_YEAR;
    }

    const ctxCanvas=document.getElementById('reportChart').getContext('2d');
    let chart=null;

    function createOrUpdateChart(year,revealWeeks=null){
      const yearStruct=buildYearStructure(year);
      const mappedScores=mapReportsToYear(year,yearStruct);
      const displayed=mappedScores.map((v,i)=>revealWeeks==null?v:(i<revealWeeks?v:null));

      const monthsInfo=yearStruct.months.map(m=>({name:m.name,startIndex:m.startIndex,endIndex:m.endIndex}));

      const options={maintainAspectRatio:true,responsive:true,layout:{padding:{bottom:56}},plugins:{legend:{display:false},tooltip:{callbacks:{title:items=>yearStruct.labels[items[0].dataIndex]||'',label:ctx=>`Score: ${ctx.formattedValue??'—'}%`}}},scales:{y:{min:0,max:100,title:{display:true,text:'Score'},ticks:{stepSize:10}},x:{display:false,grid:{display:false}}},interaction:{mode:'nearest',intersect:false},elements:{point:{radius:4,hoverRadius:6},line:{tension:0.28}},animation:{duration:360}};

      const data={labels:yearStruct.labels,datasets:[{label:'Score',data:displayed,borderColor:'rgba(37,99,235,0.95)',backgroundColor:'rgba(37,99,235,0.08)',pointBackgroundColor:'rgba(37,99,235,0.95)',spanGaps:true,cubicInterpolationMode:'monotone',showLine:true}]};

      if(!chart){
        chart=new Chart(ctxCanvas,{type:'line',data,options});
      } else {
        chart.options=options;
        chart.data=data;
        chart._monthsInfo=monthsInfo;
        chart.update();
      }
      chart._monthsInfo=monthsInfo;
    }

    function revealForSelectedYear(){
      const year=Number(yearSelect.value);
      const struct=buildYearStructure(year);
      let reveal=null;
      const elapsed=weeksElapsedThisYear(year);
      if(elapsed!=null) reveal=Math.min(elapsed,struct.totalWeeks);
      createOrUpdateChart(year,reveal);
    }

    populateYearSelect();
    yearSelect.addEventListener('change',()=>revealForSelectedYear());
    revealForSelectedYear();

    document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
      btn.addEventListener('shown.bs.tab',()=>{if(chart) chart.resize();});
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>