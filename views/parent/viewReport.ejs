<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Progress Report â€“ <%= student.fullName %></title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .heading { color: #870216; }
    .chart-card { padding: 1rem; }
    .chart-card canvas {
      height: 360px !important;
      width: 100% !important;
      display: block;
    }
    .controls-inline { display:flex; gap:.5rem; align-items:center; }
    .year-select { min-width:110px; }
  </style>
</head>

<body class="bg-light">

<%- include('../partials/parentNavbar') %>
<%- include('../partials/sidebar') %>

<div class="main-content">
<div class="container py-4">

<div class="card rounded-4 shadow-sm p-4">

<!-- ================= Breadcrumb ================= -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item">
      <a href="/parent/dashboard" class="text-decoration-none">Dashboard</a>
    </li>
    <li class="breadcrumb-item active">Progress Report</li>
  </ol>
</nav>

<!-- ================= Heading ================= -->
<div class="text-center mb-4">
  <h4 class="fw-bold heading fs-2">Student Progress Report</h4>
</div>

<!-- ================= Summary ================= -->
<div class="row g-3 mb-4 justify-content-center">
  <div class="col-md-4 col-sm-6">
    <div class="card rounded-4 shadow-sm p-4 text-center bg-success-subtle">
      <h5 class="fw-bold text-primary">
        <%= reports && reports.length ? reports[reports.length - 1].score : 0 %>%
      </h5>
      <small class="text-muted">Latest Score</small>
    </div>
  </div>

  <div class="col-md-4 col-sm-6">
    <div class="card rounded-4 shadow-sm p-4 text-center bg-danger-subtle">
      <h5 class="fw-bold text-success">
        <%= reports ? reports.length : 0 %>
      </h5>
      <small class="text-muted">Total Reports</small>
    </div>
  </div>
</div>

<!-- ================= Chart ================= -->
<div class="card rounded-4 shadow-sm p-4 mb-4 chart-card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="controls-inline">
      <label class="text-muted">Year</label>
      <select id="yearSelect" class="form-select year-select"></select>
    </div>
    <small class="text-muted">Weekly progress grouped by month</small>
  </div>
  <canvas id="reportChart"></canvas>
</div>

<!-- ================= Tabs ================= -->
<ul class="nav nav-pills mb-3 justify-content-center">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#weekly">Weekly</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#monthly">Monthly</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#yearly">Yearly</button>
  </li>
</ul>

<div class="tab-content">

<!-- WEEKLY -->
<div class="tab-pane fade show active" id="weekly">
  <div class="card rounded-4 shadow-sm p-4">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr><th>Week</th><th>Score</th><th>Remarks</th></tr>
      </thead>
      <tbody>
        <% (reports || []).forEach(r => { if(r.type==='weekly'){ %>
        <tr>
          <td><%= r.viewDate %></td>
          <td><%= r.score %>%</td>
          <td><%= r.remarks || 'â€”' %></td>
        </tr>
        <% }}); %>
        <% if (!reports || !reports.some(r=>r.type==='weekly')) { %>
        <tr><td colspan="3" class="text-muted">No weekly data</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- MONTHLY -->
<div class="tab-pane fade" id="monthly">
  <div class="card rounded-4 shadow-sm p-4">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr><th>Month</th><th>Score</th><th>Remarks</th></tr>
      </thead>
      <tbody>
        <% (reports || []).forEach(r => { if(r.type==='monthly'){ %>
        <tr>
          <td><%= r.viewDate %></td>
          <td><%= r.score %>%</td>
          <td><%= r.remarks || 'â€”' %></td>
        </tr>
        <% }}); %>
        <% if (!reports || !reports.some(r=>r.type==='monthly')) { %>
        <tr><td colspan="3" class="text-muted">No monthly data</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- YEARLY -->
<div class="tab-pane fade" id="yearly">
  <div class="card rounded-4 shadow-sm p-4">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr><th>Year</th><th>Score</th><th>Remarks</th></tr>
      </thead>
      <tbody>
        <% (reports || []).forEach(r => { %>
        <tr>
          <td><%= r.year %></td>
          <td><%= r.score %>%</td>
          <td><%= r.remarks || 'â€”' %></td>
        </tr>
        <% }); %>
        <% if (!reports || !reports.length) { %>
        <tr><td colspan="3" class="text-muted">No yearly data</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

</div>

<div class="mt-4">
  <button class="btn btn-outline-secondary" onclick="history.back()">
    <i class="bi bi-arrow-left"></i> Back
  </button>
</div>

</div>
</div>
</div>

<!-- ================= Chart Script ================= -->
<!-- ================= Chart Script ================= -->
<script>
const rawReports = <%- JSON.stringify(reports || []) %>;
const CURRENT_YEAR = new Date().getFullYear();

function buildYearStructure(year){
  const labels=[], months=[];
  for(let m=0;m<12;m++){
    const dim=new Date(year,m+1,0).getDate();
    const weeks=Math.ceil(dim/7);
    const start=labels.length;
    const name=new Date(year,m,1).toLocaleString(undefined,{month:'short'});
    for(let w=1;w<=weeks;w++) labels.push(`${name} W${w}`);
    months.push({name,startIndex:start,endIndex:labels.length-1});
  }
  return {labels,months,totalWeeks:labels.length};
}

function mapReportsToYear(year,struct){
  const arr=new Array(struct.totalWeeks).fill(null);
  const map={};
  struct.months.forEach((m,mi)=>{
    for(let i=m.startIndex;i<=m.endIndex;i++){
      map[`${mi+1}-${i-m.startIndex+1}`]=i;
    }
  });
  rawReports.forEach(r=>{
    if(+r.year!==+year) return;
    const idx=map[`${r.month}-${r.week}`];
    if(idx!=null) arr[idx]=r.score;
  });
  return arr;
}

function weeksElapsedThisYear(year){
  if(year!==CURRENT_YEAR) return null;
  const now=new Date();
  let t=0;
  for(let m=0;m<now.getMonth();m++)
    t+=Math.ceil(new Date(year,m+1,0).getDate()/7);
  t+=Math.ceil(now.getDate()/7);
  return t;
}

/* ===== Separator Plugin ===== */
const separatorsPlugin={
  id:'separatorsPlugin',
  afterDraw(chart){
    const {ctx,chartArea,scales}=chart;
    if(!chart._monthsInfo) return;
    const x=scales.x;
    ctx.save();

    chart._monthsInfo.forEach(m=>{
      const s=x.getPixelForValue(m.startIndex);
      const e=x.getPixelForValue(m.endIndex);
      const c=(s+e)/2;
      ctx.strokeStyle='rgba(15,23,42,0.2)';
      ctx.beginPath();
      ctx.moveTo(s,chartArea.top);
      ctx.lineTo(s,chartArea.bottom);
      ctx.stroke();
      ctx.fillStyle='#111827';
      ctx.font='12px sans-serif';
      ctx.textAlign='center';
      ctx.fillText(m.name,c,chartArea.bottom+14);
    });

    ctx.restore();
  }
};
Chart.register(separatorsPlugin);

/* ===== Chart Init ===== */
const ctx=document.getElementById('reportChart').getContext('2d');
let chart;

function render(){
  const y=+yearSelect.value;
  const struct=buildYearStructure(y);
  const data=mapReportsToYear(y,struct);
  const reveal=weeksElapsedThisYear(y);
  const shown=data.map((v,i)=>reveal==null||i<reveal?v:null);

  if(!chart){
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels:struct.labels,
        datasets:[{
          data:shown,
          borderColor:'rgba(37,99,235,0.95)',
          backgroundColor:'rgba(37,99,235,0.08)',

          /* âœ… FIXES */
          spanGaps:true,           // line stays connected
          pointRadius:4,           // show ALL data points
          pointHoverRadius:7,      // bigger on hover
          pointBackgroundColor:'rgba(37,99,235,1)',
          pointBorderColor:'#fff',
          pointBorderWidth:2,
          tension:0.35
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{padding:{bottom:48}},

        /* ðŸ”‘ MAIN HOVER FIX */
        interaction:{
          mode:'index',
          intersect:false
        },

        plugins:{
          legend:{display:false},
          separatorsPlugin:{},
          tooltip:{
            enabled:true,
            callbacks:{
              title:(items)=> items[0].label,
              label:(item)=> `Score: ${item.raw}%`
            }
          }
        },
        scales:{
          y:{min:0,max:100},
          x:{display:false}
        }
      }
    });
  } else {
    chart.data.datasets[0].data=shown;
    chart.update();
  }
  chart._monthsInfo=struct.months;
}

const yearSelect=document.getElementById('yearSelect');
for(let y=CURRENT_YEAR-4;y<=CURRENT_YEAR;y++){
  const o=document.createElement('option');
  o.value=y;o.textContent=y;
  yearSelect.appendChild(o);
}
yearSelect.value=CURRENT_YEAR;
yearSelect.addEventListener('change',render);
render();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
