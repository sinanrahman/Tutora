<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Progress Report – <%= student.fullName %></title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .heading { color: #870216; }
    .chart-card canvas { height: 360px !important; width: 100% !important; }
    .controls-inline { display: flex; gap: 0.5rem; align-items: center; }
    .year-select { min-width: 120px; }
  </style>
</head>

<body class="bg-light">
<%- include('../partials/parentNavbar') %>
<%- include('../partials/sidebar') %>

<div class="main-content">
  <div class="container py-4">
    <div class="card rounded-4 shadow-sm p-4">

      <!-- Breadcrumb -->
      <nav class="mb-3">
        <a href="/parent/dashboard" class="text-decoration-none">Dashboard</a>
        <span class="text-muted">/ Progress Report</span>
      </nav>

      <h4 class="fw-bold heading text-center mb-4">Student Progress Report</h4>

      <!-- SUMMARY -->
      <div class="row mb-4 justify-content-center">
        <div class="col-md-4">
          <div class="card p-3 text-center bg-success-subtle">
            <h4><%= reports.length ? reports[reports.length-1].score : 0 %>%</h4>
            <small>Latest Score</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 text-center bg-info-subtle">
            <h4><%= reports.length %></h4>
            <small>Total Reports</small>
          </div>
        </div>
      </div>

      <!-- CHART -->
      <div class="card rounded-4 shadow-sm p-4 mb-4">
        <div class="d-flex justify-content-between mb-2">
          <div class="controls-inline">
            <select id="yearSelect" class="form-select year-select"></select>
            <select id="typeSelect" class="form-select year-select">
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <small id="chartHint" class="text-muted"></small>
        </div>
        <canvas id="reportChart"></canvas>
      </div>

      <!-- TABLE TABS (UNCHANGED) -->
      <ul class="nav nav-pills mb-3 justify-content-center">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#weekly">
            Weekly
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#monthly">
            Monthly
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- WEEKLY TABLE -->
        <div class="tab-pane fade show active" id="weekly">
          <table class="table table-bordered text-center">
            <thead class="table-light">
              <tr>
                <th>Week</th>
                <th>Score</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <% reports.filter(r=>r.type==='weekly').forEach(r=>{ %>
              <tr>
                <td><%= r.viewDate %></td>
                <td><%= r.score %>%</td>
                <td><%= r.remarks || '—' %></td>
              </tr>
              <% }) %>
              <% if(!reports.some(r=>r.type==='weekly')){ %>
              <tr>
                <td colspan="3" class="text-muted">No weekly data</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- MONTHLY TABLE -->
        <div class="tab-pane fade" id="monthly">
          <table class="table table-bordered text-center">
            <thead class="table-light">
              <tr>
                <th>Month</th>
                <th>Score</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <% reports.filter(r=>r.type==='monthly').forEach(r=>{ %>
              <tr>
                <td><%= r.viewDate %></td>
                <td><%= r.score %>%</td>
                <td><%= r.remarks || '—' %></td>
              </tr>
              <% }) %>
              <% if(!reports.some(r=>r.type==='monthly')){ %>
              <tr>
                <td colspan="3" class="text-muted">No monthly data</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>

      </div>

      <button onclick="history.back()" class="btn btn-outline-secondary mt-3">
        <i class="bi bi-arrow-left"></i> Back
      </button>

    </div>
  </div>
</div>

<!-- ================= CHART SCRIPT ================= -->
<script>
const rawReports = <%- JSON.stringify(reports) %>;
const CURRENT_YEAR = new Date().getFullYear();

const yearSelect = document.getElementById('yearSelect');
const typeSelect = document.getElementById('typeSelect');
const chartHint = document.getElementById('chartHint');
const ctx = document.getElementById('reportChart').getContext('2d');

let chart;

/* YEAR OPTIONS */
for (let y = CURRENT_YEAR - 4; y <= CURRENT_YEAR; y++) {
  yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
}
yearSelect.value = CURRENT_YEAR;

/* WEEKLY DATA */
function weeklyData(year) {
  const labels = [];
  const data = [];

  for (let m = 1; m <= 12; m++) {
    const weeks = Math.ceil(new Date(year, m, 0).getDate() / 7);
    const mName = new Date(year, m - 1, 1).toLocaleString('default', { month: 'short' });

    const monthlyReport = rawReports.find(r =>
      r.year === year && r.type === 'monthly' && r.month === m
    );

    for (let w = 1; w <= weeks; w++) {
      labels.push(`${mName} W${w}`);

      const weeklyReport = rawReports.find(r =>
        r.year === year && r.type === 'weekly' && r.month === m && r.week === w
      );

      if (weeklyReport) data.push(weeklyReport.score);
      else if (monthlyReport) data.push(monthlyReport.score);
      else data.push(null);
    }
  }
  return { labels, data };
}

/* MONTHLY DATA */
function monthlyData(year) {
  const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const data = new Array(12).fill(null);

  for (let m = 1; m <= 12; m++) {
    const r = rawReports.find(r =>
      r.year === year && r.type === 'monthly' && r.month === m
    );
    if (r) data[m - 1] = r.score;
  }
  return { labels, data };
}

/* RENDER CHART */
function renderChart() {
  const year = +yearSelect.value;
  const type = typeSelect.value;
  const payload = type === 'monthly' ? monthlyData(year) : weeklyData(year);

  chartHint.textContent =
    type === 'monthly'
      ? 'Monthly performance overview'
      : 'Weekly performance (all weeks)';

  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: payload.labels,
        datasets: [{
          data: payload.data,
          spanGaps: true,
          tension: 0.35,
          pointRadius: 3,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,.08)',
          pointBackgroundColor: '#2563eb'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { min: 0, max: 100 },
          x: {
            ticks: {
              autoSkip: true,
              maxTicksLimit: 12,
              callback: (val, index) =>
                type === 'monthly'
                  ? payload.labels[index]   // Jan, Feb, Mar
                  : payload.labels[index].split(' ')[0] // Jan W1 → Jan
            }
          }
        }
      }
    });
  } else {
    chart.data.labels = payload.labels;
    chart.data.datasets[0].data = payload.data;
    chart.options.scales.x.ticks.callback = (val, index) =>
      type === 'monthly'
        ? payload.labels[index]
        : payload.labels[index].split(' ')[0];
    chart.update();
  }
}

yearSelect.onchange = renderChart;
typeSelect.onchange = renderChart;
renderChart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
