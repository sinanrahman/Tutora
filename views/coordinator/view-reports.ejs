<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Reports – <%= student.fullName %>
	</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.css">

	<style>
		.main-content {
			min-height: 100vh;
			margin-left: 220px;
			padding: 20px;
			margin-top: 40px;
			background-color: #f8f9fa;
		}

		.heading {
			color: #870216;
		}

		.dt-center {
			text-align: center;
		}

		.remarks-preview {
			max-width: 250px;
			word-break: break-word;
		}

		.mobile-topbar {
			z-index: 1100;
		}

		.mobile-logo-img {
			height: 40px;
		}

		@media (max-width: 768px) {
			.main-content {
				margin-left: 0;
				padding-top: 90px;
			}

			.navbar {
				display: none !important;
			}

			#sidebar {
				transform: translateX(-100%);
				transition: transform 0.3s ease;
			}

			#sidebar.active {
				transform: translateX(0);
			}
		}
	</style>
</head>

<body class="bg-light">

	<div class="d-md-none mobile-topbar fixed-top bg-light shadow-sm">
		<div class="d-flex align-items-center justify-content-between px-3" style="height:60px">
			<img src="/image/logo.png" class="mobile-logo-img">
			<button class="btn btn-light" onclick="toggleSidebar()">
				<i class="bi bi-list fs-4"></i>
			</button>
		</div>
	</div>

	<%- include('../partials/coordinatorNavbar') %>
		<%- include('../partials/sidebar') %>

			<div class="main-content">
				<div class="card shadow-sm border-0">

					<nav style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
						<ol class="breadcrumb p-3 mb-0">
							<li class="breadcrumb-item">
								<a href="/coordinator/dashboard">Home</a>
							</li>
							<li class="breadcrumb-item">
								<a href="/coordinator/students">Students</a>
							</li>
							<li class="breadcrumb-item">
								<a href="/coordinator/student/<%= studentId %>">Student Profile</a>
							</li>
							<li class="breadcrumb-item active" aria-current="page">
								View Report
							</li>
						</ol>
					</nav>

					<div class="card-body">
						<div class="text-center mb-4">
							<h3 class="fw-bold heading">REPORT</h3>
							<a href="/coordinator/add-report/<%= studentId %>" class="btn btn-success btn-sm">
								Add Report
							</a>
						</div>

						<div class="table-responsive">
							<table id="reportsTable" class="table table-bordered table-hover align-middle">
								<thead class="table-light">
									<tr>
										<th class="dt-center">#</th>
										<th class="dt-center">Type</th>
										<th class="dt-center">Period</th>
										<th class="dt-center">Score</th>
										<th>Remarks</th>
										<th class="dt-center">Actions</th>
									</tr>
								</thead>

								<tbody>
									<% reports.forEach((r,i)=>{
										const remarks = r.remarks || '';
										const preview = remarks.length > 25 ? remarks.substring(0,25)+'...' : remarks;
										%>

										<tr>
											<td class="dt-center">
												<%= i+1 %>
											</td>
											<td class="dt-center">
												<%= (r.type||'weekly').toUpperCase() %>
											</td>
											<td class="dt-center">
												<%= r.viewDate || '-' %>
											</td>
											<td class="dt-center">
												<span class="badge bg-primary">
													<%= r.score || '-' %>
												</span>
											</td>

											<td class="remarks-preview">
												<%= preview || '—' %>
													<% if(remarks.length>25){ %>
														<a href="#" class="text-primary" data-bs-toggle="modal"
															data-bs-target="#remarksModal<%= r._id %>">
															Read more
														</a>
														<% } %>
											</td>

											<td class="dt-center d-flex justify-content-center gap-1">
												<button class="btn btn-sm btn-info" data-bs-toggle="modal"
													data-bs-target="#editModal<%= r._id %>">
													<i class="bi bi-pencil-square"></i>
												</button>

												<button class="btn btn-sm btn-danger" data-bs-toggle="modal"
													data-bs-target="#deleteModal<%= r._id %>">
													<i class="bi bi-trash"></i>
												</button>
											</td>
										</tr>

										<!-- READ MORE MODAL -->
										<div class="modal fade" id="remarksModal<%= r._id %>">
											<div class="modal-dialog modal-lg modal-dialog-centered">
												<div class="modal-content">
													<div class="modal-header">
														<h5 class="modal-title">Remarks</h5>
														<button class="btn-close" data-bs-dismiss="modal"></button>
													</div>
													<div class="modal-body">
														<p>
															<%= remarks %>
														</p>
													</div>
												</div>
											</div>
										</div>

										<!-- EDIT MODAL -->
										<div class="modal fade" id="editModal<%= r._id %>">
											<div class="modal-dialog modal-dialog-centered">
												<div class="modal-content">
													<form action="/coordinator/edit-report/<%= r._id %>" method="POST">
														<div class="modal-header">
															<h5>Edit Report</h5>
															<button class="btn-close" data-bs-dismiss="modal"></button>
														</div>
														<div class="modal-body">
															<input type="number" name="score" class="form-control mb-2"
																value="<%= r.score %>" required>
															<textarea name="remarks"
																class="form-control mb-2"><%= r.remarks %></textarea>
															<select name="type" class="form-select mb-2">
																<option value="weekly" <%=r.type==='weekly'
																	?'selected':'' %>>Weekly</option>
																<option value="monthly" <%=r.type==='monthly'
																	?'selected':'' %>>Monthly</option>
															</select>
															<input type="date" name="viewDate" class="form-control"
																value="<%= `${r.year}-${String(r.month).padStart(2,'0')}-${String(r.day).padStart(2,'0')}` %>"
																required>

														</div>
														<div class="modal-footer">
															<button class="btn btn-secondary"
																data-bs-dismiss="modal">Cancel</button>
															<button class="btn btn-primary">Save</button>
														</div>
													</form>
												</div>
											</div>
										</div>

										<!-- DELETE MODAL -->
										<div class="modal fade" id="deleteModal<%= r._id %>">
											<div class="modal-dialog modal-dialog-centered">
												<div class="modal-content">
													<div class="modal-header">
														<h5>Delete Report</h5>
														<button class="btn-close" data-bs-dismiss="modal"></button>
													</div>
													<div class="modal-body">
														Are you sure?
													</div>
													<div class="modal-footer">
														<form action="/coordinator/delete-report/<%= r._id %>"
															method="POST">
															<button class="btn btn-danger">Delete</button>
														</form>
													</div>
												</div>
											</div>
										</div>

										<% }) %>
								</tbody>
							</table>
						</div>

					</div>
				</div>
			</div>

			<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
			<script src="https://cdn.datatables.net/2.3.6/js/dataTables.js"></script>

			<script>
				$('#reportsTable').DataTable({
					pageLength: 10,
					columnDefs: [{ orderable: false, targets: 5 }]
				});

				function toggleSidebar() {
					document.getElementById('sidebar').classList.toggle('active');
				}

			</script>

</body>

</html>