<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Reports – <%= student.fullName %></title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- Bootstrap & Icons -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

	<!-- DataTables -->
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.css">

	<style>
		.main-content {
			min-height: 100vh;
			margin-left: 220px;
			padding: 20px;
			margin-top: 40px;
			background-color: #f8f9fa;
		}

		.heading {
			color: #870216;
		}

		.badge {
			font-size: 0.9rem;
		}

		.dt-center {
			text-align: center;
		}

		.mobile-topbar {
			z-index: 1100;
		}

		.mobile-logo-img {
			height: 40px;
			width: auto;
		}

		@media (max-width: 768px) {
			.main-content {
				margin-left: 0;
				padding-top: 90px;
				padding-left: 15px;
				padding-right: 15px;
			}

			.navbar {
				display: none !important;
			}

			#sidebar {
				transform: translateX(-100%);
				transition: transform 0.3s ease;
			}

			#sidebar.active {
				transform: translateX(0);
			}
		}
	</style>
</head>

<body class="bg-light">

	<!-- Mobile Topbar -->
	<div class="d-md-none mobile-topbar fixed-top bg-light shadow-sm">
		<div class="d-flex align-items-center justify-content-between px-3" style="height: 60px">
			<img src="/image/logo.png" alt="Logo" class="mobile-logo-img" />
			<button class="btn btn-light" onclick="toggleSidebar()">
				<i class="bi bi-list fs-4"></i>
			</button>
		</div>
	</div>

	<%- include('../partials/coordinatorNavbar') %>
	<%- include('../partials/sidebar') %>

	<div class="main-content">

		<div class="card shadow-sm border-0">

			<nav style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
				<ol class="breadcrumb p-3 mb-0">
					<li class="breadcrumb-item">
						<a href="/coordinator/dashboard">Home</a>
					</li>
					<li class="breadcrumb-item">
						<a href="/coordinator/students">Students</a>
					</li>
					<li class="breadcrumb-item">
						<a href="/coordinator/student/<%= studentId %>">Student Profile</a>
					</li>
					<li class="breadcrumb-item active">Reports</li>
				</ol>
			</nav>

			<div class="card-body">
				<div class="text-center mb-4">
					<h3 class="fw-bold heading mb-2">REPORT</h3>
					<a href="/coordinator/add-report/<%= studentId %>" class="btn btn-success btn-sm">
						Add Report
					</a>
				</div>

				<% if (!reports || reports.length === 0) { %>
					<p class="text-center text-muted mb-0">No reports found</p>
				<% } else { %>

				<div class="table-responsive">
					<table id="reportsTable"
						class="table table-hover table-bordered table-striped align-middle">
						<thead class="table-light">
							<tr>
								<th class="dt-center">#</th>
								<th class="dt-center">Type</th>
								<th class="dt-center">Period</th>
								<th class="dt-center">Score</th>
								<th>Remarks</th>
								<th class="dt-center">Actions</th>
							</tr>
						</thead>
						<tbody>
							<% reports.forEach((r, i)=> { %>
							<tr>
								<td class="dt-center"><%= i + 1 %></td>
								<td class="dt-center"><%= (r.type || 'weekly').toUpperCase() %></td>
								<td class="dt-center"><%= r.viewDate || '-' %></td>
								<td class="dt-center">
									<span class="badge bg-primary"><%= r.score || '-' %></span>
								</td>
								<td><%= r.remarks || '—' %></td>
								<td class="dt-center d-flex">

									<button class="btn btn-sm btn-info me-1"
										data-bs-toggle="modal"
										data-bs-target="#editModal<%= r._id %>">
										<i class="bi bi-pencil-square"></i>
									</button>

									<button class="btn btn-sm btn-danger"
										data-bs-toggle="modal"
										data-bs-target="#deleteModal<%= r._id %>">
										<i class="bi bi-trash"></i>
									</button>

									<!-- Edit Modal -->
									<div class="modal fade" id="editModal<%= r._id %>" tabindex="-1">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content">
												<form action="/coordinator/edit-report/<%= r._id %>" method="POST">
													<div class="modal-header">
														<h5 class="modal-title">Edit Report</h5>
														<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
													</div>
													<div class="modal-body">
														<div class="mb-3">
															<label class="form-label">Score</label>
															<input type="number" name="score" class="form-control"
																min="0" max="100" value="<%= r.score %>" required>
														</div>
														<div class="mb-3">
															<label class="form-label">Remarks</label>
															<textarea name="remarks" class="form-control" rows="2"><%= r.remarks %></textarea>
														</div>
														<div class="mb-3">
															<label class="form-label">Type</label>
															<select name="type" class="form-select">
																<option value="weekly" <%= r.type==='weekly'?'selected':'' %>>Weekly</option>
																<option value="monthly" <%= r.type==='monthly'?'selected':'' %>>Monthly</option>
															</select>
														</div>
														<div class="mb-3">
															<label class="form-label">Date</label>
															<input type="date" name="viewDate" class="form-control"
																value="<%= r.viewDate || '' %>" required>
														</div>
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
															Cancel
														</button>
														<button type="submit" class="btn btn-primary">
															Save Changes
														</button>
													</div>
												</form>
											</div>
										</div>
									</div>

									<!-- Delete Modal -->
									<div class="modal fade" id="deleteModal<%= r._id %>" tabindex="-1">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title">Delete Report</h5>
													<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
												</div>
												<div class="modal-body">
													Are you sure you want to delete this report?
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
														Cancel
													</button>
													<form action="/coordinator/delete-report/<%= r._id %>" method="POST">
														<button type="submit" class="btn btn-danger">Delete</button>
													</form>
												</div>
											</div>
										</div>
									</div>

								</td>
							</tr>
							<% }) %>
						</tbody>
					</table>
				</div>
				<% } %>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.datatables.net/2.3.6/js/dataTables.js"></script>

	<script>
		$(document).ready(function () {
			$('#reportsTable').DataTable({
				pageLength: 10,
				lengthMenu: [5, 10, 25, 50],
				order: [[0, "desc"]],
				columnDefs: [
					{ orderable: false, targets: 5 },
					{ className: "dt-center", targets: [0, 1, 2, 3] }
				]
			});
		});

		function toggleSidebar() {
			document.getElementById('sidebar').classList.toggle('active');
		}

		document.addEventListener('click', function (e) {
			const sidebar = document.getElementById('sidebar');
			const toggleBtn = document.querySelector('.bi-list')?.parentElement;

			if (
				window.innerWidth < 768 &&
				sidebar.classList.contains('active') &&
				!sidebar.contains(e.target) &&
				!toggleBtn?.contains(e.target)
			) {
				sidebar.classList.remove('active');
			}
		});
	</script>

</body>
</html>
