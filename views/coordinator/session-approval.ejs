<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Session History</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- Bootstrap & Icons -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

	<!-- DataTables -->
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.css" />

	<style>
		.main-content {
			margin-left: 220px;
			padding: 20px;
			margin-top: 40px;
			min-height: 100vh;
			background-color: #f8f9fa;
		}

		.card {
			border-radius: 10px;
		}

		.heading {
			color: #870216;
		}

		.mobile-topbar {
			z-index: 1100;
		}

		.mobile-logo-img {
			height: 40px;
			width: auto;
		}

		@media (max-width: 768px) {
			.main-content {
				margin-left: 0 !important;
				padding: 15px;
				padding-top: 90px;
			}
		}
	</style>
</head>

<body>

	<%- include('../partials/coordinatorNavbar') %>
	<%- include('../partials/sidebar') %>

	<!-- Mobile Topbar -->
	<div class="d-md-none mobile-topbar fixed-top bg-light shadow-sm">
		<div class="d-flex align-items-center justify-content-between px-3" style="height: 60px">
			<img src="/image/logo.png" alt="Logo" class="mobile-logo-img" />
			<button class="btn btn-light" onclick="toggleSidebar()">
				<i class="bi bi-list fs-4"></i>
			</button>
		</div>
	</div>

	<div class="main-content p-5">

		<div class="card shadow-sm border-0">

			<!-- Breadcrumb -->
			<nav style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
				<ol class="breadcrumb p-3">
					<li class="breadcrumb-item">
						<a href="/coordinator/Dashboard">Home</a>
					</li>
					<li class="breadcrumb-item active">Session History</li>
				</ol>
			</nav>

			<div class="card-body">

				<!-- Heading -->
				<div class="d-flex flex-column justify-content-center align-items-center mb-4">
					<h3 class="fw-bold fs-2 heading">SESSION HISTORY</h3>
				</div>

				<!-- Pending Sessions -->
				<div class="mb-5">
					<h5 class="fw-bold mb-3">Pending Sessions</h5>

					<% if (pendingSessions.length === 0) { %>
						<p class="text-muted">No pending sessions</p>
					<% } else { %>
						<div class="table-responsive">
							<table id="pendingTable"
								class="table table-hover table-striped align-middle">
								<thead class="table-light">
									<tr>
										<th>Student</th>
										<th>Teacher</th>
										<th>Date</th>
										<th>Duration</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<% pendingSessions.forEach(s => { %>
										<tr>
											<td><%= s.student.fullName %></td>
											<td><%= s.teacher.fullName %></td>
											<td><%= new Date(s.date).toLocaleDateString() %></td>
											<td><%= s.durationInHours %> hrs</td>
											<td>
												<button class="btn btn-sm btn-success"
													data-bs-toggle="modal"
													data-bs-target="#sessionModal"
													data-id="<%= s._id %>"
													data-student="<%= s.student.fullName %>"
													data-teacher="<%= s.teacher.fullName %>"
													data-date="<%= new Date(s.date).toLocaleDateString() %>"
													data-duration="<%= s.durationInHours %>">
													View
												</button>
											</td>
										</tr>
									<% }) %>
								</tbody>
							</table>
						</div>
					<% } %>
				</div>

				<!-- Approved Sessions -->
				<div>
					<h5 class="fw-bold mb-3">Approved Sessions</h5>

					<% if (approvedSessions.length === 0) { %>
						<p class="text-muted">No approved sessions</p>
					<% } else { %>
						<div class="table-responsive">
							<table id="approvedTable"
								class="table table-hover table-striped align-middle">
								<thead class="table-light">
									<tr>
										<th>Student</th>
										<th>Teacher</th>
										<th>Date</th>
										<th>Duration</th>
										<th>Status</th>
									</tr>
								</thead>
								<tbody>
									<% approvedSessions.forEach(s => { %>
										<tr>
											<td><%= s.student.fullName %></td>
											<td><%= s.teacher.fullName %></td>
											<td><%= new Date(s.date).toLocaleDateString() %></td>
											<td><%= s.durationInHours %> hrs</td>
											<td>
												<span class="badge bg-success">Approved</span>
											</td>
										</tr>
									<% }) %>
								</tbody>
							</table>
						</div>
					<% } %>
				</div>

			</div>
		</div>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="sessionModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<form id="sessionForm">
					<div class="modal-header">
						<h5 class="modal-title">Review Session</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p><strong>Student:</strong> <span id="modalStudent"></span></p>
						<p><strong>Teacher:</strong> <span id="modalTeacher"></span></p>
						<p><strong>Date:</strong> <span id="modalDate"></span></p>

						<div class="mb-3">
							<label class="form-label">Duration (hours)</label>
							<input type="number"  min="0" step="any"
								id="modalDuration" class="form-control" required>
						</div>
					</div>
					<div class="modal-footer">
						<button class="btn btn-success">Approve</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.datatables.net/2.3.6/js/dataTables.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		$(document).ready(function () {
			new DataTable('#pendingTable', {
				columnDefs: [{ orderable: false, targets: 4 }]
			});
			new DataTable('#approvedTable', {
				order: [[2, 'desc']]
			});
		});

		const sessionModal = document.getElementById('sessionModal');
		const sessionForm = document.getElementById('sessionForm');

		sessionModal.addEventListener('show.bs.modal', e => {
			const b = e.relatedTarget;
			sessionForm.dataset.id = b.dataset.id;
			modalStudent.textContent = b.dataset.student;
			modalTeacher.textContent = b.dataset.teacher;
			modalDate.textContent = b.dataset.date;
			modalDuration.value = b.dataset.duration;
		});

		sessionForm.addEventListener('submit', async e => {
			e.preventDefault();
			await fetch(`/coordinator/sessions/approve/${sessionForm.dataset.id}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ action: 'approve', durationInHours: modalDuration.value })
			});
			location.reload();
		});

		function toggleSidebar() {
			document.getElementById('sidebar').classList.toggle('active');
		}
	</script>

</body>
</html>
