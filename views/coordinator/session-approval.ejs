<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Session Approval</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
<%-include('../admin/partials/navbar') %>

     <%-include('../partials/coordinatorSidebar')%>

	 <nav style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
        <ol class="breadcrumb  m-5 p-3">
          <li class="breadcrumb-item "><a href="/coordinator/Dashboard">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">sessionHistory</li>
        </ol>
      </nav>

			<h1 class="text-center mt-5 fw-bold" style="color: #870216;">Session History</h1>

		<div class="container-fluid pl-5 d-flex justify-content-center">
			<div class="row pl-5">
				<div class="col-md-12 pl-5 mt-4">
					<h5 class="mb-3 fw-bold">Pending Sessions</h5>

					<% if (pendingSessions.length===0) { %>
						<p class="text-muted">No pending sessions</p>
						<% } else { %>
							<table class="table table-bordered table-hover">
								<thead class="table-warning">
									<tr>
										<th>Student</th>
										<th>Teacher</th>
										<th>Date</th>
										<th>Duration</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<% pendingSessions.forEach(s=> { %>
										<tr>
											<td>
												<%= s.student.fullName %>
											</td>
											<td>
												<%= s.teacher.fullName %>
											</td>
											<td>
												<%= new Date(s.date).toLocaleDateString() %>
											</td>
											<td>
												<%= s.durationInHours %> hrs
											</td>
											<td>
												<button type="button" class="btn btn-success btn-sm"
													data-bs-toggle="modal" data-bs-target="#sessionModal"
													data-id="<%= s._id %>" data-student="<%= s.student.fullName %>"
													data-teacher="<%= s.teacher.fullName %>"
													data-date="<%= new Date(s.date).toLocaleDateString() %>"
													data-duration="<%= s.durationInHours %>">
													View
												</button>
											</td>
										</tr>
										<% }) %>
								</tbody>
							</table>
							<% } %>
				</div>
				<div class="col-md-12 mt-5">
					<h5 class="mb-3 fw-bold">Approved Session</h5>

					<% if (approvedSessions.length===0) { %>
						<p class="text-muted">No approved sessions</p>
						<% } else { %>
							<table class="table table-bordered table-hover">
								<thead class="table-success">
									<tr>
										<th>Student</th>
										<th>Teacher</th>
										<th>Date</th>
										<th>Duration</th>
										<th>Status</th>
									</tr>
								</thead>
								<tbody>
									<% approvedSessions.forEach(s=> { %>
										<tr>
											<td>
												<%= s.student.fullName %>
											</td>
											<td>
												<%= s.teacher.fullName %>
											</td>
											<td>
												<%= new Date(s.date).toLocaleDateString() %>
											</td>
											<td>
												<%= s.durationInHours %> hrs
											</td>
											<td><span class="badge bg-success">Approved</span></td>
										</tr>
										<% }) %>
								</tbody>

							</table>
							<% } %>
				</div>
			</div>
		</div>
		<div class="modal fade" id="sessionModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<form method="POST" id="sessionForm">
						<div class="modal-header">
							<h5 class="modal-title">Review Session</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>

						<div class="modal-body">
							<p>
								<strong>Student:</strong>
								<span id="modalStudent"></span>
							</p>
							<p>
								<strong>Teacher:</strong>
								<span id="modalTeacher"></span>
							</p>
							<p>
								<strong>Date:</strong>
								<span id="modalDate"></span>
							</p>

							<div class="mb-3">
								<label class="form-label">Duration (hours)</label>
								<input type="number" min="0" step="0.25" name="durationInHours" id="modalDuration"
									class="form-control" required />

							</div>
						</div>

						<div class="modal-footer">
							<button type="submit" class="btn btn-success">
								Approve
							</button>

						</div>
					</form>
				</div>
			</div>
		</div>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			const sessionModal = document.getElementById('sessionModal');
			const sessionForm = document.getElementById('sessionForm');

			sessionModal.addEventListener('show.bs.modal', function (event) {
				const button = event.relatedTarget;

				sessionForm.dataset.id = button.dataset.id;

				document.getElementById('modalStudent').textContent = button.dataset.student;
				document.getElementById('modalTeacher').textContent = button.dataset.teacher;
				document.getElementById('modalDate').textContent = button.dataset.date;
				document.getElementById('modalDuration').value = button.dataset.duration;
			});

			sessionForm.addEventListener('submit', async function (e) {
				e.preventDefault();

				const id = sessionForm.dataset.id;
				const duration = document.getElementById('modalDuration').value;

				try {
					const res = await fetch(`/coordinator/sessions/approve/${id}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: 'approve',
							durationInHours: duration
						})
					});

					if (!res.ok) {
						const text = await res.text();
						throw new Error(text);
					}

					await res.json();

					bootstrap.Modal.getInstance(sessionModal).hide();
					location.reload();

				} catch (err) {
					alert(err.message);
				}
			});
		</script>

</body>

</html>